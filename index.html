<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>研究室チェックイン</title>
<style>
  body{font-family:system-ui, sans-serif; padding:20px; max-width:540px; margin:auto}
  .card{border:1px solid #ddd; border-radius:16px; padding:16px; margin:16px 0; box-shadow:0 2px 10px rgba(0,0,0,.04)}
  button{font-size:18px; padding:12px 16px; border-radius:12px; border:0; cursor:not-allowed; opacity:.5}
  button.active{background:#2563eb; color:#fff; cursor:pointer; opacity:1}
  .ok{color:#16a34a} 
  .bad{color:#dc2626}
  small{color:#555}
  ul{padding-left:1rem}
</style>

<div class="card">
  <h1>研究室チェックイン</h1>
  <p>位置情報の許可をお願いします。到着の可否はサーバ側で判定されます。</p>
  <div id="status">現在地を測位中…</div>
  <div><small id="debug"></small></div>
  <div style="margin-top:12px">
    <button id="checkin" disabled>到着（チェックイン）</button>
  </div>
</div>

<div class="card" id="statsCard">
  <h2>サマリー</h2>
  <div id="stats">読み込み中…</div>
  <h3 style="margin-top:12px">直近のログ</h3>
  <ul id="latest"></ul>
</div>

<script>
  // あなたのGASデプロイURLを指定
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbzIip6DxyRSUONCNf1GxXMCvszCbcaMdJTu4v57qHvJadVozfghisZ8EtQePu68qe-mPw/exec";

  const statusEl = document.getElementById('status');
  const debugEl  = document.getElementById('debug');
  const checkinBtn = document.getElementById('checkin');
  const statsEl  = document.getElementById('stats');
  const latestEl = document.getElementById('latest');

  let lastPos = null;
  let lastPosAt = 0;

  function getPosition(opts={enableHighAccuracy:true, timeout:8000, maximumAge:0}) {
    return new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(resolve, reject, opts);
    });
  }

  async function refreshPositionUI(){
    if(!navigator.geolocation){
      statusEl.innerHTML = '<span class="bad">この端末は位置情報に対応していません。</span>';
      return;
    }
    try{
      const pos = await getPosition();
      const {latitude, longitude, accuracy} = pos.coords;
      lastPos = pos; lastPosAt = Date.now();
      statusEl.innerHTML = '<span class="ok">測位に成功しました。チェックインできます。</span>';
      debugEl.textContent = `lat=${latitude.toFixed(6)}, lng=${longitude.toFixed(6)}, accuracy≈${accuracy}m`;
      enableButton(true);
    }catch(err){
      statusEl.innerHTML = `<span class="bad">測位に失敗：${err.message}。位置情報の許可を確認してください。</span>`;
      enableButton(false);
    }
  }

  function enableButton(enable){
    checkinBtn.disabled = !enable;
    checkinBtn.classList.toggle('active', enable);
  }

  async function loadStats(){
    try {
      const url = GAS_ENDPOINT + '?mode=stats&_=' + Date.now();
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const json = await res.json();
      if(!json.ok) throw new Error('bad response');

      const cls = (n)=> n>0?'ok':(n<0?'bad':'');
      const fmt = (n)=> (n>=0?'+':'') + n + 'pt';

      statsEl.innerHTML = `
        本日の合計：<b class="${cls(json.totalToday)}">${fmt(json.totalToday)}</b><br>
        今週の合計：<b class="${cls(json.totalWeek)}">${fmt(json.totalWeek)}</b><br>
        今月の合計：<b class="${cls(json.totalMonth)}">${fmt(json.totalMonth)}</b><br>
        これまでの合計：<b class="${cls(json.totalAll)}">${fmt(json.totalAll)}</b>
      `;

      latestEl.innerHTML = '';
      (json.latest || []).forEach(r=>{
        const c = r.pt>0?'ok':(r.pt<0?'bad':'');
        const li = document.createElement('li');
        li.innerHTML = `${r.date} ${r.time} <b class="${c}">${fmt(r.pt)}</b>`;
        latestEl.appendChild(li);
      });
    } catch(e){
      console.error(e);
      statsEl.textContent = '集計の取得に失敗しました。';
      latestEl.innerHTML = '';
    }
  }

  async function sendCheckin(){
    const originalLabel = checkinBtn.textContent;
    enableButton(false);
    checkinBtn.textContent = '送信中…';
    try{
      let pos = lastPos && (Date.now()-lastPosAt)<15000
        ? lastPos
        : await getPosition({enableHighAccuracy:true, timeout:8000, maximumAge:0});

      const {latitude: lat, longitude: lng} = pos.coords;

      const url = GAS_ENDPOINT + '?ua=' + encodeURIComponent(navigator.userAgent);

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({ type:'checkin', lat, lng, ts: Date.now() })
      });
      const text = await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0,200)}`);

      const json = JSON.parse(text);
      if(!json.ok){
        alert(json.message || json.error || 'チェックインに失敗しました。');
        return;
      }
      await loadStats();
      const amount = Number.isFinite(Number(json.pt)) ? Number(json.pt) : 0;
      alert(`チェックインを記録しました。\n今回のポイント: ${(amount>=0?'+':'')+amount}pt`);
    }catch(err){
      console.error(err);
      alert('送信エラー：' + (err.message || String(err)));
    }finally{
      checkinBtn.textContent = originalLabel;
      enableButton(true);
      refreshPositionUI();
    }
  }

  checkinBtn.addEventListener('click', sendCheckin);

  refreshPositionUI();
  setInterval(refreshPositionUI, 30000);
  loadStats();
  setInterval(loadStats, 30000);
</script>
</html>