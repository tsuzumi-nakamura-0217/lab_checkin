<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>研究室チェックイン</title>
<style>
  /* 基本のリセット・可読性 */
  *{box-sizing:border-box}
  html,body{margin:0; padding:0}
  html{overflow-x:hidden}
  body{
    font-family:system-ui, -apple-system, Segoe UI, Roboto, "ヒラギノ角ゴ ProN", Meiryo, sans-serif;
    padding:20px; max-width:540px; margin:auto; line-height:1.6;
    font-size:clamp(14px, 3.5vw, 16px);
  }
  h1, h2, h3, h4{text-align:center; margin:0.3em 0}

  .card{border:1px solid #ddd; border-radius:16px; padding:16px; margin:16px 0; box-shadow:0 2px 10px rgba(0,0,0,.04); background:#fff}

  /* ボタン行：モバイルは縦積み、横幅広がれば横並び */
  .btn-row{display:flex; gap:8px; flex-direction:column}
  @media (min-width:480px){
    .btn-row{flex-direction:row}
  }
  button{
    font-size:1rem; padding:12px 16px; border-radius:12px; border:0;
    cursor:not-allowed; opacity:.5; width:100%;
  }
  button.active{background:#2563eb; color:#fff; cursor:pointer; opacity:1}

  .ok{color:#16a34a} 
  .bad{color:#dc2626}
  .warn{color:#9333ea}
  .stay{color:#eab308}
  small{color:#555; display:block; word-break:break-all; font-weight: normal;}
  ul{padding-left:1rem}
  table{border-collapse:collapse; width:100%; margin-top:8px}
  th,td{border:1px solid #ddd; padding:8px; text-align:center}
  th{background-color:#f5f5f5; font-weight:600}
  tr:nth-child(even){background-color:#f9f9f9}
  .week-separator{border-top:2px solid #666; background-color:#e5e5e5}
  .weekday{font-size:1em; color:#333; font-weight:600}

  /* サマリーは1列→2列に切替 */
  .summary-grid{
    display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px
  }
  @media (min-width:480px){
    .summary-grid{grid-template-columns:1fr 1fr}
  }
  .summary-card{border:1px solid #e5e5e5; border-radius:12px; padding:16px; text-align:center; background:#fafafa}
  .summary-card h4{margin:0 0 8px 0; font-size:0.9em; color:#333; font-weight:700; text-transform:uppercase; letter-spacing:0.5px}
  .summary-card .value{font-size:2em; font-weight:bold; margin:0; line-height:1.2}
  .summary-card .label{font-size:0.75em; color:#666; margin-top:8px; font-weight:500}

  /* 直近ログのラベル行（見出し）もグリッドで */
  .log-header{
    display:grid; grid-template-columns:1fr auto; gap:4px 8px;
    padding:0 4px 8px; margin:4px 0 8px; border-bottom:1px solid #e5e5e5; color:#666; font-weight:600;
    align-items:center;
    grid-template-areas:
      "date points"
      "time points";
  }
  @media (min-width:600px){
    .log-header{
      grid-template-columns: minmax(0,1fr) 120px 90px;
      grid-template-areas: "date time points";
    }
  }
  .log-header .log-date{grid-area:date; text-align:left}
  .log-header .log-time{grid-area:time; text-align:left}
  .log-header .log-points{grid-area:points; text-align:right}

  /* ログの1行：狭い幅では2列2行、広い幅で3列 */
  .log-card{
    border:1px solid #e5e5e5; border-radius:8px; padding:12px; margin:8px 0;
    background:#fafafa; display:grid; gap:4px 8px; align-items:center;
    grid-template-columns:1fr auto;
    grid-template-areas:
      "date points"
      "time points";
  }
  @media (min-width:600px){
    .log-card{
      grid-template-columns: minmax(0,1fr) 120px 90px;
      grid-template-areas: "date time points";
    }
  }
  .log-date{grid-area:date; font-weight:600; color:#333; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .log-time{grid-area:time; color:#666; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .log-points{grid-area:points; font-weight:bold; font-size:1.1em; text-align:right}

  /* 細かな余白調整（スマホで詰めすぎない） */
  #latest h4, #stats h4{margin:12px 0}
  /* 直近ログをスクロール可能にする */
  #latest{
    max-height: 500px;   /* 任意の高さ */
    overflow-y: auto;
  }

  /* ヘッダを固定 */
  #latest .log-header{
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 2;  /* 上に重ねる */
  }


</style>

<div class="card">
  <h1>研究室チェックイン</h1>
  <p>位置情報の許可をお願いします。到着の可否はサーバ側で判定されます。</p>
  <div id="status">現在地を測位中…</div>
  <div><small id="debug"></small></div>

  <div class="btn-row" style="margin-top:12px">
    <button id="checkin" disabled>チェックイン</button>
    <button id="checkinPre" disabled>チェックイン（事前申請）</button>
    <button id="stay" disabled>宿泊</button>
  </div>
</div>

<div class="card" id="statsCard">
  <h2>サマリー</h2>
  <div id="stats"><h4>読み込み中…</h4></div>
  <h3 style="margin-top:12px">直近のログ</h3>
  <div id="latest"><h4>読み込み中…</h4></div>
</div>
<script>
  // あなたのGASデプロイURLを指定（最新デプロイに更新！）
  const GAS_ENDPOINT = "https://script.google.com/macros/s/AKfycbyvgoOwW_5_QxTXdKxVmndPlulHtWAT3CXb17xoRoRW9rgSwqh3zlw-04twP6PDmxVvTg/exec";

  const statusEl = document.getElementById('status');
  const debugEl  = document.getElementById('debug');
  const checkinBtn = document.getElementById('checkin');
  const stayBtn = document.getElementById('stay');
  const checkinPreBtn = document.getElementById('checkinPre');
  const statsEl  = document.getElementById('stats');
  const latestEl = document.getElementById('latest');

  let lastPos = null;
  let lastPosAt = 0;

  // ------------------------------
  // 位置情報
  // ------------------------------
  function getPosition(opts={enableHighAccuracy:true, timeout:8000, maximumAge:0}) {
    return new Promise((resolve, reject)=>{
      navigator.geolocation.getCurrentPosition(resolve, reject, opts);
    });
  }

  async function refreshPositionUI(){
    if(!navigator.geolocation){
      statusEl.innerHTML = '<span class="bad">この端末は位置情報に対応していません。</span>';
      return;
    }
    try{
      const pos = await getPosition();
      const {latitude, longitude, accuracy} = pos.coords;
      lastPos = pos; lastPosAt = Date.now();
      statusEl.innerHTML = '<span class="ok">測位に成功しました。</span>';
      debugEl.textContent = `lat=${latitude.toFixed(6)}, lng=${longitude.toFixed(6)}, accuracy≈${accuracy}m`;
      enableButton(true);
    }catch(err){
      statusEl.innerHTML = `<span class="bad">測位に失敗：${err.message}。位置情報の許可を確認してください。</span>`;
      enableButton(false);
    }
  }

  function enableButton(enable){
    checkinBtn.disabled = !enable;
    checkinBtn.classList.toggle('active', enable);
    checkinPreBtn.disabled = !enable;
    checkinPreBtn.classList.toggle('active', enable);
    stayBtn.disabled = !enable;
    stayBtn.classList.toggle('active', enable);
  }

  // ------------------------------
  // 時刻ユーティリティ
  // ------------------------------
  // 文字列から時:分を取り出して "hh:mm" で返す（失敗時は null）
  function toHHmm(s){
    if(!s || typeof s !== 'string') return null;
    s = s.trim();

    const pad = (n)=> String(n).padStart(2, '0');

    // パターン1: "HH:mm" / "H:mm" / 全角コロン
    let m = s.match(/(\d{1,2})[:：](\d{2})/);
    if(m){
      const hh = Math.min(23, parseInt(m[1],10));
      const mm = Math.min(59, parseInt(m[2],10));
      return `${pad(hh)}:${pad(mm)}`;
    }

    // パターン2: 文中の "H:MM" / "HH:MM"
    m = s.match(/\b(\d{1,2}):(\d{2})\b/);
    if(m){
      const hh = Math.min(23, parseInt(m[1],10));
      const mm = Math.min(59, parseInt(m[2],10));
      return `${pad(hh)}:${pad(mm)}`;
    }

    // パターン3: "930" → 09:30, "1234" → 12:34
    m = s.match(/^\s*(\d{1,2})(\d{2})\s*$/);
    if(m){
      const hh = Math.min(23, parseInt(m[1],10));
      const mm = Math.min(59, parseInt(m[2],10));
      return `${pad(hh)}:${pad(mm)}`;
    }

    return null;
  }

  // "hh:mm" / "h:mm" / "930" を [hh, mm] へ（失敗は null）
  function parseHHmm(s){
    if(!s || typeof s !== 'string') return null;
    s = s.trim();
    let m = s.match(/(\d{1,2})[:：](\d{2})/);           // 09:30 / 9:30 / 全角:
    if(!m) m = s.match(/\b(\d{1,2}):(\d{2})\b/);        // 文中末尾など
    if(!m) m = s.match(/^\s*(\d{1,2})(\d{2})\s*$/);     // 930 → 09:30
    if(!m) return null;
    const h  = Math.min(23, parseInt(m[1],10));
    const mm = Math.min(59, parseInt(m[2],10));
    return [h, mm];
  }

  // "yyyy/MM/dd" と (hh,mm) から Date
  function makeDateFromYmdHm(ymd, hh, mm){
    const [y,m,d] = ymd.split('/').map(Number);
    return new Date(y, m-1, d, hh, mm, 0, 0);
  }

  // 対象曜日（Mon/Tue/Thu/Fri）
  function isAllowedDay(d){
    const wd = d.getDay(); // 0..6 (Sun..Sat)
    return wd === 1 || wd === 2 || wd === 4 || wd === 5;
  }

  // 週開始（日曜0時）
  function startOfWeekLocal(d){
    const t = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
    const wd = t.getDay(); // 0=Sun
    t.setDate(t.getDate() - wd);
    return t;
  }

  // ------------------------------
  // GAS computePt_ 相当のフロント再計算
  // - preApplied があればそれをターゲットに、なければ 11:00
  // - 早着: floor(h)*+100, 遅刻: ceil(h)*-100
  // - 対象曜日外は 0pt
  // - absence であっても再計算（表示は「無断欠席」）
  // ------------------------------
  function computePtLikeGAS(dateStr, timeStr, preAppliedRaw){
    // 実測時刻（stats.latest の time は "HH:mm:ss" 前提）
    const [hh, mm, ss] = (timeStr || '00:00:00').split(':').map(x=>parseInt(x||'0',10));
    const when = new Date(
      ...((()=>{ const [y,m,d]=dateStr.split('/').map(Number); return [y, m-1, d, hh||0, mm||0, ss||0, 0]; })())
    );

    // ターゲット（preApplied 優先、なければ 11:00）
    let targetH = 11, targetM = 0;
    const parsed = parseHHmm(preAppliedRaw);
    if(parsed){ targetH = parsed[0]; targetM = parsed[1]; }
    const target = makeDateFromYmdHm(dateStr, targetH, targetM);

    let pt = 0, note = '';
    if(!isAllowedDay(when)){
      note = '対象外曜日 → 0pt';
    }else{
      const diffMs = when - target; // +遅刻 / -早着
      if(diffMs > 0){
        const hoursLate = Math.ceil(diffMs / 3600000);
        pt  = -100 * hoursLate;
        note = `遅刻 ${hoursLate}時間 → ${pt}pt`;
      }else if(diffMs < 0){
        const hoursEarly = Math.floor(Math.abs(diffMs) / 3600000);
        pt  = 100 * hoursEarly;
        note = (hoursEarly === 0) ? '早着 <1h → 0pt' : `早着 ${hoursEarly}時間 → +${pt}pt`;
      }else{
        note = `${String(targetH).padStart(2,'0')}:${String(targetM).padStart(2,'0')} ちょうど → 0pt`;
      }
    }
    const targetStr = `${dateStr} ${String(targetH).padStart(2,'0')}:${String(targetM).padStart(2,'0')}`;
    return { pt, note, targetStr };
  }

  // ------------------------------
  // Stats の取得＆フロント再計算表示
  // ------------------------------
  async function loadStats(){
    try {
      const url = GAS_ENDPOINT + '?mode=stats&_=' + Date.now();
      const res = await fetch(url);
      const text = await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0,200)}`);

      let json;
      try{
        json = JSON.parse(text);
      }catch(parseErr){
        throw new Error('非JSON応答（ログイン/HTMLの可能性）: ' + text.slice(0,200));
      }
      if(!json.ok) throw new Error('bad response');

      // ----- ここからフロント側でポイントを再計算 -----
      const recalc = (json.latest || []).map(r=>{
        if (r.type === 'stay') {
          // 宿泊は再計算せず固定
          return { ...r, calcPt: -500, calcNote: '宿泊 → 一律 -500pt', calcTarget: '' };
        }
        const calc = computePtLikeGAS(r.date, r.time, r.preApplied);
        return { ...r, calcPt: calc.pt, calcNote: calc.note, calcTarget: calc.targetStr };
      });

      // サマリー集計（本日/今週/今月/総合）
      const now = new Date();
      const pad2 = (n)=> String(n).padStart(2,'0');
      const tzTodayStr = `${now.getFullYear()}/${pad2(now.getMonth()+1)}/${pad2(now.getDate())}`;
      const weekStart = startOfWeekLocal(now);
      const weekStartKey = Number(`${weekStart.getFullYear()}${pad2(weekStart.getMonth()+1)}${pad2(weekStart.getDate())}`);
      const thisMonthKey = `${now.getFullYear()}/${pad2(now.getMonth()+1)}`;

      let totalToday = 0, totalWeek = 0, totalMonth = 0, totalAll = 0;

      for(const r of recalc){
        const ymdKey = Number(r.date.replaceAll('/',''));
        const ymKey  = r.date.slice(0,7); // "yyyy/MM"
        totalAll += r.calcPt;
        if(r.date === tzTodayStr) totalToday += r.calcPt;
        if(ymdKey >= weekStartKey) totalWeek += r.calcPt;
        if(ymKey === thisMonthKey) totalMonth += r.calcPt;
      }

      // ----- 本日の暫定ポイント（本日の記録が無い & 該当曜日のみ）-----
      let isProvisionalToday = false;
      const hasTodayRecord = recalc.some(r => r.date === tzTodayStr);
      if(!hasTodayRecord && isAllowedDay(now)){
        const hh = pad2(now.getHours()), mm = pad2(now.getMinutes()), ss = pad2(now.getSeconds());
        const tmp = computePtLikeGAS(tzTodayStr, `${hh}:${mm}:${ss}`, null); // 既定=11:00基準
        totalToday = tmp.pt;
        isProvisionalToday = true;
        // 暫定ポイントを今週・今月・総合にも加算
        totalWeek += tmp.pt;
        totalMonth += tmp.pt;
        totalAll += tmp.pt;
      }

      // 表示ヘルパ
      const cls = (n)=> {
        if(n > 0) return 'ok';
        if(n < 0) return 'bad';
        return '';
      };
      const fmt = (n)=> (n>=0?'+':'') + n + 'pt';

      // サマリー（再計算値で描画）— 本日だけ暫定ラベルを出す場合あり
      statsEl.innerHTML = `
        <div class="summary-grid">
          <div class="summary-card">
            <h4>本日</h4>
            <p class="value ${cls(totalToday)}">${fmt(totalToday)}</p>
            ${isProvisionalToday ? `<div class="label">暫定（未チェックイン）</div>` : ``}
          </div>
          <div class="summary-card">
            <h4>今週</h4>
            <p class="value ${cls(totalWeek)}">${fmt(totalWeek)}</p>
          </div>
          <div class="summary-card">
            <h4>今月</h4>
            <p class="value ${cls(totalMonth)}">${fmt(totalMonth)}</p>
          </div>
          <div class="summary-card">
            <h4>総合</h4>
            <p class="value ${cls(totalAll)}">${fmt(totalAll)}</p>
          </div>
        </div>
      `;

      // 直近ログ
      latestEl.innerHTML = '';

      // 並び替え（日時降順）
      const parseDT = (r)=>{
        const [y,m,d] = r.date.split('/').map(Number);
        const [hh,mm,ss] = (r.time || '00:00:00').split(':').map(Number);
        return new Date(y, m-1, d, hh||0, mm||0, ss||0);
      };
      const latest = [...recalc].sort((a,b)=> parseDT(b) - parseDT(a));

      if (latest.length > 0) {
        const header = document.createElement('div');
        header.className = 'log-header';
        header.innerHTML = `
          <div class="log-date">日付</div>
          <div class="log-time">チェックイン</div>
          <div class="log-points">ポイント</div>
        `;
        latestEl.appendChild(header);
      }

      let lastWeek = null;

      latest.forEach((r)=>{
        const [y,mn,dd] = r.date.split('/').map(Number);
        const date = new Date(y, mn-1, dd);
        const dayOfWeek = date.getDay(); // 0=日, 1=月, ..., 6=土
        const weekStart = new Date(date);
        weekStart.setDate(date.getDate() - dayOfWeek);
        const weekKey = weekStart.toISOString().split('T')[0];

        if(lastWeek !== null && lastWeek !== weekKey){
          const sep = document.createElement('div');
          sep.className = 'week-separator';
          sep.style.height = '2px';
          sep.style.margin = '12px 0';
          latestEl.appendChild(sep);
        }
        lastWeek = weekKey;

        // 表示用の時刻文字列
        let timeDisplay = r.time;
        let isStay = false;
        if (r.type === 'absence') {
          timeDisplay = '無断欠席';
        } else if (r.type === 'stay') {
          timeDisplay = '宿泊';
          isStay = true;
        } else if (r.time) {
          const [hh, mm] = r.time.split(':');
          timeDisplay = `${hh}:${mm}`;
        }

        // ポイントの色（宿泊だけは独自色、その他は pt で色分け）
        const pointClass = isStay ? 'stay' : (r.calcPt > 0 ? 'ok' : (r.calcPt == -1300 ? 'warn' : 'bad'));

        // 事前申請の表示（hh:mm に整形）
        const pre = toHHmm(r.preApplied);

        const weekdays = ['日','月','火','水','木','金','土'];
        const weekday = weekdays[dayOfWeek];

        const row = document.createElement('div');
        row.className = 'log-card';
        row.innerHTML = `
          <div class="log-date">
            ${r.date} <span class="weekday">（${weekday}）</span>
            ${pre ? `<small>事前申請: ${pre}</small>` : ``}
          </div>
          <div class="log-time">${timeDisplay}</div>
          <div class="log-points ${pointClass}">${fmt(r.calcPt)}</div>
        `;
        latestEl.appendChild(row);
      });
    } catch(e){
      console.error(e);
      statsEl.textContent = '集計の取得に失敗しました。コンソールをご確認ください。';
      latestEl.innerHTML = '';
    }
  }

  // ------------------------------
  // チェックイン送信
  // ------------------------------
  async function sendCheckin(isStay = false){
    const originalLabel = checkinBtn.textContent;
    const stayOriginalLabel = stayBtn.textContent;
    enableButton(false);
    checkinBtn.textContent = '送信中…';
    stayBtn.textContent = '送信中…';
    try{
      let pos = lastPos && (Date.now()-lastPosAt)<15000
        ? lastPos
        : await getPosition({enableHighAccuracy:true, timeout:8000, maximumAge:0});

      const {latitude: lat, longitude: lng} = pos.coords;

      const url = GAS_ENDPOINT + '?ua=' + encodeURIComponent(navigator.userAgent);

      // 宿泊でも押した瞬間の時刻をそのまま使う
      const timestamp = Date.now();

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          type: isStay ? 'stay' : 'checkin',  // ← 宿泊は 'stay' で送信
          lat, lng, ts: timestamp
        })
      });
      const text = await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0,200)}`);

      let json;
      try{
        json = JSON.parse(text);
      }catch(parseErr){
        throw new Error('非JSON応答: ' + text.slice(0,200));
      }

      if(!json.ok){
        alert(json.message || json.error || 'チェックインに失敗しました。');
        return;
      }
      await loadStats();
      const serverPtNum = Number(json.pt);
      const amount =
        Number.isFinite(serverPtNum)
          ? serverPtNum
          : (isStay ? -500 : 0); // ← サーバ未設定でも宿泊は -500pt を表示
      alert(`チェックインを記録しました。\n今回のポイント: ${(amount>=0?'+':'')+amount}pt`);
    }catch(err){
      console.error(err);
      alert('送信エラー：' + (err.message || String(err)));
    }finally{
      checkinBtn.textContent = originalLabel;
      stayBtn.textContent = stayOriginalLabel;
      enableButton(true);
      refreshPositionUI();
    }
  }

  async function sendCheckinWithPre(){
    const input = prompt('事前申請のターゲット時刻を入力してください（例: 12:30　半角）\n※ 時と分のみ。年月日は自動で付与されます。');
    if (input === null) return;

    const hhmm = toHHmm(String(input));
    if (!hhmm) {
      alert('時刻の形式が正しくありません（例: 09:30, 930, 9:05, 12:00）');
      return;
    }

    const originalLabel1 = checkinBtn.textContent;
    const originalLabel2 = checkinPreBtn.textContent;
    const originalLabel3 = stayBtn.textContent;
    enableButton(false);
    checkinBtn.textContent = '送信中…';
    checkinPreBtn.textContent = '送信中…';
    stayBtn.textContent = '送信中…';

    try{
      let pos = lastPos && (Date.now()-lastPosAt)<15000
        ? lastPos
        : await getPosition({enableHighAccuracy:true, timeout:8000, maximumAge:0});
      const {latitude: lat, longitude: lng} = pos.coords;

      const url = GAS_ENDPOINT + '?ua=' + encodeURIComponent(navigator.userAgent);
      const timestamp = Date.now();

      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          type: 'checkin',
          lat, lng, ts: timestamp,
          preApplied: hhmm   // ← 事前申請時刻を送る
        })
      });
      const text = await res.text();
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.slice(0,200)}`);

      const json = JSON.parse(text);
      if(!json.ok){
        alert(json.message || json.error || 'チェックインに失敗しました。');
        return;
      }
      await loadStats();
      const serverPtNum = Number(json.pt);
      alert(`チェックイン（事前申請あり）を記録しました。\n今回のポイント: ${(serverPtNum>=0?'+':'')+serverPtNum}pt\nターゲット: ${json.target || '(不明)'}`);
    }catch(err){
      console.error(err);
      alert('送信エラー：' + (err.message || String(err)));
    }finally{
      checkinBtn.textContent = originalLabel1;
      checkinPreBtn.textContent = originalLabel2;
      stayBtn.textContent = originalLabel3;
      enableButton(true);
      refreshPositionUI();
    }
  }

  function sendStay(){ sendCheckin(true); }

  checkinBtn.addEventListener('click', sendCheckin);
  checkinPreBtn.addEventListener('click', sendCheckinWithPre);
  stayBtn.addEventListener('click', sendStay);

  // 初期化
  refreshPositionUI();
  setInterval(refreshPositionUI, 30000);
  loadStats();
  setInterval(loadStats, 30000);
</script>

</html>
